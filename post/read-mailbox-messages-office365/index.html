<!doctype html><html lang=es itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Leer mensajes de un buzón de Office 365 con C# - Programación desordenada</title>
<meta name=description content="Usando MailKit o Microsoft Graph API"><meta name=author content="Sergio León"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"Programación desordenada","url":"https:\/\/panicoenlaxbox.com\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/panicoenlaxbox.com\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/panicoenlaxbox.com\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/panicoenlaxbox.com\/post\/read-mailbox-messages-office365\/","name":"Leer mensajes de un buzón de office 365 con c#"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Sergio León"},"headline":"Leer mensajes de un buzón de Office 365 con C#","description":"Es cierto que, a priori, el título del post no levanta grandes pasiones, pero si por el camino aprendemos a usar MailKit, configuramos permisos en Azure y lo comparamos con el SDK de Microsoft Graph API, el tema algo mejora.\n","inLanguage":"es","wordCount":529,"datePublished":"2024-03-22T16:26:00","dateModified":"2024-03-22T16:26:00","image":"https:\/\/panicoenlaxbox.com\/img\/avatar-icon.png","keywords":["csharp, azure"],"mainEntityOfPage":"https:\/\/panicoenlaxbox.com\/post\/read-mailbox-messages-office365\/","publisher":{"@type":"Organization","name":"https:\/\/panicoenlaxbox.com\/","logo":{"@type":"ImageObject","url":"https:\/\/panicoenlaxbox.com\/img\/avatar-icon.png","height":60,"width":60}}}</script><meta property="og:title" content="Leer mensajes de un buzón de Office 365 con C#"><meta property="og:description" content="Usando MailKit o Microsoft Graph API"><meta property="og:image" content="https://panicoenlaxbox.com/img/avatar-icon.png"><meta property="og:url" content="https://panicoenlaxbox.com/post/read-mailbox-messages-office365/"><meta property="og:type" content="website"><meta property="og:site_name" content="Programación desordenada"><meta name=twitter:title content="Leer mensajes de un buzón de Office 365 con C#"><meta name=twitter:description content="Usando MailKit o Microsoft Graph API"><meta name=twitter:image content="https://panicoenlaxbox.com/img/avatar-icon.png"><meta name=twitter:card content="summary"><meta name=twitter:site content="@panicoenlaxbox"><meta name=twitter:creator content="@panicoenlaxbox"><link href=https://panicoenlaxbox.com/img/favicon.ico rel=icon type=image/x-icon><meta name=generator content="Hugo 0.124.1"><link rel=alternate href=https://panicoenlaxbox.com/index.xml type=application/rss+xml title="Programación desordenada"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://panicoenlaxbox.com/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://panicoenlaxbox.com/css/highlight.min.css><link rel=stylesheet href=https://panicoenlaxbox.com/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><style>.intro-header .archive-heading{text-align:center}.intro-header .archive-heading h1{margin-top:0;font-size:50px}@media only screen and (min-width:768px){.intro-header .archive-heading h1{font-size:80px}}.post-entry a{color:#008aff}body.dark-mode,body.dark-mode main *{background:#2d2d2d;color:#f5f5f5}body.dark-mode .post-title,body.dark-mode .post-subtitle{color:#f5f5f5}body.dark-mode .post-entry a{color:#008aff}body.dark-mode table tr th,body.dark-mode table tr td{color:#333}blockquote{margin:20px}table{margin-top:10px}</style><script>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-57023975-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Conmuta navegación</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=https://panicoenlaxbox.com/>Programación desordenada</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Tags href=/tags>Tags</a></li><li><a title=Archive href=/archive>Archive</a></li><li><a title=About href=/about>About</a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title="Programación desordenada" href=https://panicoenlaxbox.com/><img class=avatar-img src=https://panicoenlaxbox.com/img/avatar-icon.png alt="Programación desordenada"></a></div></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>Leer mensajes de un buzón de Office 365 con C#</h1><h2 class=post-subheading>Usando MailKit o Microsoft Graph API</h2><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Publicado el March 22, 2024</span></div></div></div></div></div></header><div class=js-toggle-wrapper><div class=js-toggle><div class=js-toggle-track><div class=js-toggle-track-check><img src="data:image/png;base64,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" role=presentation style=pointer-events:none width=16 height=16></div><div class=js-toggle-track-x><img src="data:image/png;base64,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" role=presentation style=pointer-events:none width=16 height=16></div></div><div class=js-toggle-thumb></div><input class=js-toggle-screenreader-only type=checkbox aria-label="Switch between Dark and Light mode"></div></div><style>.js-toggle-wrapper{display:table;margin:0 auto}.js-toggle{touch-action:pan-x;display:inline-block;position:relative;cursor:pointer;background-color:transparent;border:0;padding:0;-webkit-touch-callout:none;user-select:none;-webkit-tap-highlight-color:transparent;-webkit-tap-highlight-color:transparent}.js-toggle-screenreader-only{border:0;clip:rect(0 0 0 0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px}.js-toggle-track{width:50px;height:24px;padding:0;border-radius:30px;background-color:#0f1114;transition:all .2s ease}.js-toggle-track-check{position:absolute;width:17px;height:17px;left:5px;top:0;bottom:0;margin-top:auto;margin-bottom:auto;line-height:0;opacity:0;transition:opacity .25s ease}.js-toggle--checked .js-toggle-track-check{opacity:1;transition:opacity .25s ease}.js-toggle-track-x{position:absolute;width:17px;height:17px;right:5px;top:0;bottom:0;margin-top:auto;margin-bottom:auto;line-height:0;opacity:1;transition:opacity .25s ease}.js-toggle--checked .js-toggle-track-x{opacity:0}.js-toggle-thumb{position:absolute;top:1px;left:1px;width:22px;height:22px;border-radius:50%;background-color:#fafafa;box-sizing:border-box;transition:all .5s cubic-bezier(.23,1,.32,1)0ms;transform:translateX(0)}.js-toggle--checked .js-toggle-thumb{transform:translateX(26px);border-color:#19ab27}.js-toggle--focus .js-toggle-thumb{box-shadow:0 0 2px 3px #ffa7c4}.js-toggle:active .js-toggle-thumb{box-shadow:0 0 5px 5px #ffa7c4}</style><script>var body=document.body,switcher=document.getElementsByClassName("js-toggle")[0];switcher.addEventListener("click",function(){this.classList.toggle("js-toggle--checked"),this.classList.add("js-toggle--focus"),this.classList.contains("js-toggle--checked")?(body.classList.add("dark-mode"),localStorage.setItem("darkMode","true")):(body.classList.remove("dark-mode"),setTimeout(function(){localStorage.removeItem("darkMode")},100))}),localStorage.getItem("darkMode")&&(switcher.classList.add("js-toggle--checked"),body.classList.add("dark-mode"))</script><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><p>Es cierto que, a priori, el título del post no levanta grandes pasiones, pero si por el camino aprendemos a usar <a href=https://github.com/jstedfast/MailKit>MailKit</a>, configuramos permisos en Azure y lo comparamos con el <a href=https://github.com/microsoftgraph/msgraph-sdk-dotnet>SDK de Microsoft Graph API</a>, el tema algo mejora.</p><p>Aparentemente, leer los mensajes de un buzón de Office 365 debería ser una tarea sencilla. Lógicamente, al final todo se complica o, simplemente, no es tan directo como prometía inicialmente.</p><blockquote><p>Para los ejemplos, el programa se ejecutará como una aplicación en segundo plano, es decir, no habrá delegación de permisos por parte de un usuario, luego los permisos en Azure serán del tipo <em>Application</em> en vez de <em>Delegated</em>.</p></blockquote><p>Inicialmente, probaremos a usar <a href="https://github.com/jstedfast/MailKit?tab=readme-ov-file#using-imap">MailKit</a> con el protocolo IMAP. Para ello, nuestra primera parada será la documentación oficial <a href=https://learn.microsoft.com/en-us/exchange/client-developer/legacy-protocols/how-to-authenticate-an-imap-pop-smtp-application-by-using-oauth>Authenticate an IMAP, POP or SMTP connection using OAuth</a>.</p><p>Los pasos a seguir son:</p><ul><li>Crear un <em>App registration</em>, un secreto, darle el permiso <em>Office 365 Exchange Online | IMAP.AccessAsApp</em> y dar consentimiento de administrador con <em>Grand admin consent for&mldr;</em></li><li>Configurar en el <a href=https://admin.exchange.microsoft.com/>centro de administración de Exchange</a> la delegación de uno o más buzones para el <em>App registration</em> recién creado.</li></ul><p><img src=images/IMAP_API_Permission.png alt=IMAP_API_Permission></p><p>La delegación del buzón la haremos con PowerShell, pero antes un par de aclaraciones:</p><ul><li><code>YOUR_TENANT_ID</code> es <em>Directory (tenant) ID</em> como aparece en <em>App registrations</em>.</li><li><code>YOUR_APPLICATION_ID</code> es <em>Application (client) ID</em> como aparece en <em>App registrations</em>.</li><li><code>YOUR_OBJECT_ID</code> es <em>Object ID</em> como aparece en <em>Entreprise applications</em>.</li><li><code>YOUR_EMAIL</code> es&mldr; ¡exacto!, el email que queremos leer.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Install-Module</span> <span class=n>-Name</span> <span class=n>ExchangeOnlineManagement</span>
</span></span><span class=line><span class=cl><span class=nb>Connect-ExchangeOnline</span> <span class=n>-Organization</span> <span class=n>YOUR_TENANT_ID</span>
</span></span><span class=line><span class=cl><span class=nb>New-ServicePrincipal</span> <span class=n>-AppId</span> <span class=n>YOUR_APPLICATION_ID</span> <span class=n>-ObjectId</span> <span class=n>YOUR_OBJECT_ID</span>
</span></span><span class=line><span class=cl><span class=nb>Add-MailboxPermission</span> <span class=n>-Identity</span> <span class=s2>&#34;YOUR_EMAIL&#34;</span> <span class=n>-User</span> <span class=n>YOUR_OBJECT_ID</span> <span class=n>-AccessRights</span> <span class=n>FullAccess</span>
</span></span></code></pre></div><p>Podemos confirmar que todo fue bien desde el portal de administración de Exchange.</p><p><img src=images/Exchange_FullAccess.png alt=Exchange_FullAccess.png></p><p>Aquí aparecera <code>YOUR_OBJECT_ID</code>:</p><p><img src=images/Exchange_FullAccess_ObjectId.png alt=Exchange_FullAccess_ObjectId.png></p><p>También podemos ejecutar <code>Get-MailboxPermission -Identity "YOUR_EMAIL"</code> para verlo desde línea de comandos.</p><p>Es poco probable que no lo esté, pero confirma también que IMAP esté activado para el buzón.</p><p><img src=images/IMAP.png alt=IMAP.png></p><p>En este momento, ya podemos empezar a escribir nuestro programa en C# usando <em>MailKit</em>.</p><p>Los paquetes necesarios son:</p><ul><li><code>Microsoft.Identity.Client</code>.</li><li><code>MailKit</code>.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=k>using</span> <span class=nn>MailKit</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>MailKit.Net.Imap</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>MailKit.Security</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>Microsoft.Identity.Client</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=k>await</span> <span class=n>GetCountAsync</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>async</span> <span class=n>Task</span><span class=p>&lt;</span><span class=kt>int</span><span class=p>&gt;</span> <span class=n>GetCountAsync</span><span class=p>(</span><span class=n>CancellationToken</span> <span class=n>cancellationToken</span> <span class=p>=</span> <span class=k>default</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>    
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>authToken</span> <span class=p>=</span> <span class=k>await</span> <span class=n>GetAuthToken</span><span class=p>(</span><span class=n>cancellationToken</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>mechanism</span> <span class=p>=</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>SaslMechanismOAuth2</span><span class=p>(</span><span class=s>&#34;YOUR_EMAIL&#34;</span><span class=p>,</span> <span class=n>authToken</span><span class=p>.</span><span class=n>AccessToken</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>using</span> <span class=nn>var</span> <span class=n>imapClient</span> <span class=p>=</span> <span class=k>new</span> <span class=n>ImapClient</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>imapClient</span><span class=p>.</span><span class=n>ConnectAsync</span><span class=p>(</span><span class=s>&#34;outlook.office365.com&#34;</span><span class=p>,</span> <span class=m>993</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>SecureSocketOptions</span><span class=p>.</span><span class=n>SslOnConnect</span><span class=p>,</span> <span class=n>cancellationToken</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>imapClient</span><span class=p>.</span><span class=n>AuthenticateAsync</span><span class=p>(</span><span class=n>mechanism</span><span class=p>,</span> <span class=n>cancellationToken</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>inbox</span> <span class=p>=</span> <span class=n>imapClient</span><span class=p>.</span><span class=n>Inbox</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>inbox</span><span class=p>.</span><span class=n>OpenAsync</span><span class=p>(</span><span class=n>FolderAccess</span><span class=p>.</span><span class=n>ReadOnly</span><span class=p>,</span> <span class=n>cancellationToken</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>count</span> <span class=p>=</span> <span class=n>inbox</span><span class=p>.</span><span class=n>Count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>inbox</span><span class=p>.</span><span class=n>CloseAsync</span><span class=p>(</span><span class=n>cancellationToken</span><span class=p>:</span> <span class=n>cancellationToken</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>imapClient</span><span class=p>.</span><span class=n>DisconnectAsync</span><span class=p>(</span><span class=n>quit</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span> <span class=n>cancellationToken</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>async</span> <span class=n>Task</span><span class=p>&lt;</span><span class=n>AuthenticationResult</span><span class=p>&gt;</span> <span class=n>GetAuthToken</span><span class=p>(</span><span class=n>CancellationToken</span> <span class=n>cancellationToken</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>scopes</span> <span class=p>=</span> <span class=k>new</span><span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;https://outlook.office365.com/.default&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>confidentialClientApplication</span> <span class=p>=</span> <span class=n>ConfidentialClientApplicationBuilder</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>Create</span><span class=p>(</span><span class=s>&#34;YOUR_APPLICATION_ID&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>WithClientSecret</span><span class=p>(</span><span class=s>&#34;YOUR_SECRET&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>WithAuthority</span><span class=p>(</span><span class=k>new</span> <span class=n>Uri</span><span class=p>(</span><span class=s>$&#34;https://login.microsoftonline.com/YOUR_TENANT_ID/&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>Build</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>await</span> <span class=n>confidentialClientApplication</span><span class=p>.</span><span class=n>AcquireTokenForClient</span><span class=p>(</span><span class=n>scopes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>ExecuteAsync</span><span class=p>(</span><span class=n>cancellationToken</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Si lo que queremos en usar <em>Microsoft Graph API</em>, una <a href=https://learn.microsoft.com/en-us/graph/use-the-api>API REST</a> muy completa y, probablemente, la opción recomendada, habría que instalar estos paquetes:</p><ul><li><code>Azure.Identity</code></li><li><code>Microsoft.Graph</code></li></ul><p>En cuanto a la configuración del <em>App registration</em>, esta vez hay que darle el permiso <a href=https://learn.microsoft.com/en-us/graph/permissions-reference#mailread><em>Microsoft Graph | Mail.Read</em></a>. Este permiso es más bestia que el anterior (si el administrador <a href=https://learn.microsoft.com/en-us/graph/auth-limit-mailbox-access>no configura nada para poner algún límite</a>). Ahora no habrá que delegar buzones porque el permiso permitirá leer <em>todos</em> los buzones.</p><p><img src=images/Microsoft%20Graph.png alt=Microsoft%20Graph.png></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=k>await</span> <span class=n>GetCountAsync</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>async</span> <span class=n>Task</span><span class=p>&lt;</span><span class=kt>int</span><span class=p>&gt;</span> <span class=n>GetCountAsync</span><span class=p>(</span><span class=n>CancellationToken</span> <span class=n>cancellationToken</span> <span class=p>=</span> <span class=k>default</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>credentials</span> <span class=p>=</span> <span class=k>new</span> <span class=n>ClientSecretCredential</span><span class=p>(</span><span class=s>&#34;YOUR_TENANT_ID&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;YOUR_APPLICATION_ID&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;YOUR_SECRET&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>TokenCredentialOptions</span> <span class=p>{</span> <span class=n>AuthorityHost</span> <span class=p>=</span> <span class=n>AzureAuthorityHosts</span><span class=p>.</span><span class=n>AzurePublicCloud</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>graphServiceClient</span> <span class=p>=</span> <span class=k>new</span> <span class=n>GraphServiceClient</span><span class=p>(</span><span class=n>credentials</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>user</span> <span class=p>=</span> <span class=n>graphServiceClient</span><span class=p>.</span><span class=n>Users</span><span class=p>[</span><span class=s>&#34;YOUR_EMAIL&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>inbox</span> <span class=p>=</span> <span class=p>(</span><span class=k>await</span> <span class=n>user</span><span class=p>.</span><span class=n>MailFolders</span><span class=p>[</span><span class=s>&#34;Inbox&#34;</span><span class=p>].</span><span class=n>GetAsync</span><span class=p>(</span><span class=n>cancellationToken</span><span class=p>:</span> <span class=n>cancellationToken</span><span class=p>))!;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>inbox</span><span class=p>.</span><span class=n>TotalItemCount</span><span class=p>!;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Un saludo!</p><div class=blog-tags><a href=https://panicoenlaxbox.com//tags/csharp/>csharp</a>&nbsp;
<a href=https://panicoenlaxbox.com//tags/azure/>azure</a>&nbsp;</div><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2fpanicoenlaxbox.com%2fpost%2fread-mailbox-messages-office365%2f&amp;text=Leer%20mensajes%20de%20un%20buz%c3%b3n%20de%20Office%20365%20con%20C%23&amp;via=panicoenlaxbox" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fpanicoenlaxbox.com%2fpost%2fread-mailbox-messages-office365%2f&amp;title=Leer%20mensajes%20de%20un%20buz%c3%b3n%20de%20Office%20365%20con%20C%23" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li></ul></div></div></section><h4 class=see-also>Ver también</h4><ul><li><a href=/post/console-application/>Console application vs worker service</a></li><li><a href=/post/minimal-api-swagger-enum/>Enumerados en Swagger con Minimal APIs</a></li><li><a href=/post/peter/>Peter</a></li><li><a href=/post/azurite-testcontainers/>Azurite con Testcontainers</a></li><li><a href=/post/configuration-and-secrets-in-asp-net-core/>Configuración y secretos en ASP.NET Core con Azure Key Vault y Azure App Configuration</a></li></ul></article><ul class="pager blog-pager"><li class=previous><a href=https://panicoenlaxbox.com/post/medir-lineas-de-codigo/ data-toggle=tooltip data-placement=top title="Medir líneas de código, clases y funciones en Python">&larr; Artículo anterior</a></li><li class=next><a href=https://panicoenlaxbox.com/post/console-application/ data-toggle=tooltip data-placement=top title="Console application vs worker service">Artículo siguiente &rarr;</a></li></ul><div class=disqus-comments><button id=show-comments class="btn btn-default" type=button>Mostrar <span class=disqus-comment-count data-disqus-url=https://panicoenlaxbox.com/post/read-mailbox-messages-office365>comentarios</span></button><div id=disqus_thread></div><script type=text/javascript>var disqus_config=function(){this.page.url="https://panicoenlaxbox.com/post/read-mailbox-messages-office365"}</script></div></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=mailto:panicoenlaxbox@gmail.com title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/panicoenlaxbox title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/panicoenlaxbox title=Twitter><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://linkedin.com/in/sergio-le%c3%b3n-gonz%c3%a1lez-49412642 title=LinkedIn><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a href title=RSS><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted">Sergio León
&nbsp;&bull;&nbsp;&copy;
2024
&nbsp;&bull;&nbsp;
<a href=https://panicoenlaxbox.com/>Programación desordenada</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.124.1</a> alimentada &nbsp;&bull;&nbsp; Tema <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adaptado de <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script><script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=https://panicoenlaxbox.com/js/main.js></script><script src=https://panicoenlaxbox.com/js/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>$(document).ready(function(){$("pre.chroma").css("padding","0")})</script><script>renderMathInElement(document.body)</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://panicoenlaxbox.com/js/load-photoswipe.js></script><script type=text/javascript>$(function(){$("#show-comments").on("click",function(){var e="panicoenlaxbox-github-io";(function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="//"+e+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(t)})(),$(this).hide()})})</script><script id=dsq-count-scr src=//panicoenlaxbox-github-io.disqus.com/count.js async></script></body></html>