<!doctype html><html lang=es itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Mocking vs patching en Python - Programación desordenada</title>
<meta name=description content="En este post veremos qué diferencias hay entre el mocking y el patching que, aunque relacionados, no son lo mismo. También cuando aplica uno y cuando el otro, y algunos de los inconvenientes que pueden llegar a surgir cuando los usemos."><meta name=author content="Sergio León"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"Programación desordenada","url":"https:\/\/panicoenlaxbox.com"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/panicoenlaxbox.com"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/panicoenlaxbox.com","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/panicoenlaxbox.com\/post\/mocking-vs-patching-python\/","name":"Mocking vs patching en python"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Sergio León"},"headline":"Mocking vs patching en Python","description":"En este post veremos qué diferencias hay entre el mocking y el patching que, aunque relacionados, no son lo mismo. También cuando aplica uno y cuando el otro, y algunos de los inconvenientes que pueden llegar a surgir cuando los usemos.\n","inLanguage":"es","wordCount":3316,"datePublished":"2022-07-09T11:15:20","dateModified":"2022-07-09T11:15:20","image":"https:\/\/panicoenlaxbox.com\/img\/avatar-icon.png","keywords":["python"],"mainEntityOfPage":"https:\/\/panicoenlaxbox.com\/post\/mocking-vs-patching-python\/","publisher":{"@type":"Organization","name":"https:\/\/panicoenlaxbox.com","logo":{"@type":"ImageObject","url":"https:\/\/panicoenlaxbox.com\/img\/avatar-icon.png","height":60,"width":60}}}</script><meta property="og:title" content="Mocking vs patching en Python"><meta property="og:description" content="En este post veremos qué diferencias hay entre el mocking y el patching que, aunque relacionados, no son lo mismo. También cuando aplica uno y cuando el otro, y algunos de los inconvenientes que pueden llegar a surgir cuando los usemos."><meta property="og:image" content="https://panicoenlaxbox.com/img/avatar-icon.png"><meta property="og:url" content="https://panicoenlaxbox.com/post/mocking-vs-patching-python/"><meta property="og:type" content="website"><meta property="og:site_name" content="Programación desordenada"><meta name=twitter:title content="Mocking vs patching en Python"><meta name=twitter:description content="En este post veremos qué diferencias hay entre el mocking y el patching que, aunque relacionados, no son lo mismo. También cuando aplica uno y cuando el otro, y algunos de los inconvenientes que …"><meta name=twitter:image content="https://panicoenlaxbox.com/img/avatar-icon.png"><meta name=twitter:card content="summary"><meta name=twitter:site content="@panicoenlaxbox"><meta name=twitter:creator content="@panicoenlaxbox"><link href=https://panicoenlaxbox.com/img/favicon.ico rel=icon type=image/x-icon><meta name=generator content="Hugo 0.121.2"><link rel=alternate href=https://panicoenlaxbox.com/index.xml type=application/rss+xml title="Programación desordenada"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://panicoenlaxbox.com/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://panicoenlaxbox.com/css/highlight.min.css><link rel=stylesheet href=https://panicoenlaxbox.com/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><style>.intro-header .archive-heading{text-align:center}.intro-header .archive-heading h1{margin-top:0;font-size:50px}@media only screen and (min-width:768px){.intro-header .archive-heading h1{font-size:80px}}.post-entry a{color:#008aff}body.dark-mode,body.dark-mode main *{background:#2d2d2d;color:#f5f5f5}body.dark-mode .post-title,body.dark-mode .post-subtitle{color:#f5f5f5}body.dark-mode .post-entry a{color:#008aff}body.dark-mode table tr th,body.dark-mode table tr td{color:#333}blockquote{margin:20px}table{margin-top:10px}</style><script>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-57023975-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Conmuta navegación</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=https://panicoenlaxbox.com>Programación desordenada</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Tags href=/tags>Tags</a></li><li><a title=Archive href=/archive>Archive</a></li><li><a title=About href=/about>About</a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title="Programación desordenada" href=https://panicoenlaxbox.com><img class=avatar-img src=https://panicoenlaxbox.com/img/avatar-icon.png alt="Programación desordenada"></a></div></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>Mocking vs patching en Python</h1><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Publicado el July 9, 2022</span></div></div></div></div></div></header><div class=js-toggle-wrapper><div class=js-toggle><div class=js-toggle-track><div class=js-toggle-track-check><img src="data:image/png;base64,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" role=presentation style=pointer-events:none width=16 height=16></div><div class=js-toggle-track-x><img src="data:image/png;base64,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" role=presentation style=pointer-events:none width=16 height=16></div></div><div class=js-toggle-thumb></div><input class=js-toggle-screenreader-only type=checkbox aria-label="Switch between Dark and Light mode"></div></div><style>.js-toggle-wrapper{display:table;margin:0 auto}.js-toggle{touch-action:pan-x;display:inline-block;position:relative;cursor:pointer;background-color:transparent;border:0;padding:0;-webkit-touch-callout:none;user-select:none;-webkit-tap-highlight-color:transparent;-webkit-tap-highlight-color:transparent}.js-toggle-screenreader-only{border:0;clip:rect(0 0 0 0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px}.js-toggle-track{width:50px;height:24px;padding:0;border-radius:30px;background-color:#0f1114;transition:all .2s ease}.js-toggle-track-check{position:absolute;width:17px;height:17px;left:5px;top:0;bottom:0;margin-top:auto;margin-bottom:auto;line-height:0;opacity:0;transition:opacity .25s ease}.js-toggle--checked .js-toggle-track-check{opacity:1;transition:opacity .25s ease}.js-toggle-track-x{position:absolute;width:17px;height:17px;right:5px;top:0;bottom:0;margin-top:auto;margin-bottom:auto;line-height:0;opacity:1;transition:opacity .25s ease}.js-toggle--checked .js-toggle-track-x{opacity:0}.js-toggle-thumb{position:absolute;top:1px;left:1px;width:22px;height:22px;border-radius:50%;background-color:#fafafa;box-sizing:border-box;transition:all .5s cubic-bezier(.23,1,.32,1)0ms;transform:translateX(0)}.js-toggle--checked .js-toggle-thumb{transform:translateX(26px);border-color:#19ab27}.js-toggle--focus .js-toggle-thumb{box-shadow:0 0 2px 3px #ffa7c4}.js-toggle:active .js-toggle-thumb{box-shadow:0 0 5px 5px #ffa7c4}</style><script>var body=document.body,switcher=document.getElementsByClassName("js-toggle")[0];switcher.addEventListener("click",function(){this.classList.toggle("js-toggle--checked"),this.classList.add("js-toggle--focus"),this.classList.contains("js-toggle--checked")?(body.classList.add("dark-mode"),localStorage.setItem("darkMode","true")):(body.classList.remove("dark-mode"),setTimeout(function(){localStorage.removeItem("darkMode")},100))}),localStorage.getItem("darkMode")&&(switcher.classList.add("js-toggle--checked"),body.classList.add("dark-mode"))</script><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><p>En este post veremos qué diferencias hay entre el mocking y el patching que, aunque relacionados, no son lo mismo. También cuando aplica uno y cuando el otro, y algunos de los inconvenientes que pueden llegar a surgir cuando los usemos.</p><p>En Python, no es necesario (a priori) instalar ningún paquete para hacer tests. La <em>standard library</em> ya viene de serie con <a href=https://docs.python.org/3/library/unittest.html>todo lo necesario</a> (framework de testing, test runner e incluso librería para mocking&mldr; a esto se refieren cuando dicen que Python es <em>&ldquo;batteries included&rdquo;</em>).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># a_test.py</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>unittest</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>MagicMock</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>FooTestCase</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>test_foo</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>mock_foo</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>return_value</span><span class=o>=</span><span class=s2>&#34;Foo&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=s2>&#34;Foo&#34;</span><span class=p>,</span> <span class=n>mock_foo</span><span class=p>())</span>
</span></span></code></pre></div><p>Para ejecutar el test bastaría ejecutar el comando <code>python -m unittest a_test</code>.</p><p>Este estilo de tests está inspirado en la familia de <a href=https://en.wikipedia.org/wiki/XUnit>xUnit</a> y, aunque es perfectamente válido, no es muy <a href=https://www.udacity.com/blog/2020/09/what-is-pythonic-style.html>pythonico</a>. Por eso, mucha gente opta por usar <a href=https://docs.pytest.org/>pytest</a> (ahora sí toca instalar un paquete). Se habla de <em>pruebas funcionales</em> vs <em>pruebas basadas en clases</em>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1>#test_foo.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>MagicMock</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_foo</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>mock_foo</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>return_value</span><span class=o>=</span><span class=s2>&#34;Foo&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s2>&#34;Foo&#34;</span> <span class=o>==</span> <span class=n>mock_foo</span><span class=p>()</span>
</span></span></code></pre></div><p>Con <code>pytest test_foo.py</code> podrás ejecutar el test.</p><p>Cabe mencionar que <code>pytest</code> (como <em>test runner</em>) puede <a href="https://docs.pytest.org/en/7.1.x/how-to/unittest.html?highlight=testcase">ejecutar también</a> tests creados con <code>unittest.TestCase</code>, por lo que pueden convivir ambos frameworks en el mismo proyecto sin problema.</p><p>Lo que en cualquier caso no cambia es la <em>librería de mocking</em>, que en ambas soluciones usa <a href=https://docs.python.org/3/library/unittest.mock.html>unittest.mock</a> de la <em>standard library</em>.</p><p>En cuanto a las aserciones, puedes usar <code>assert</code> o instalar alguna otra librería de aserciones como <a href=https://github.com/assertpy/assertpy>assertpy</a>, <a href=https://github.com/grappa-py/grappa>grappa</a>, <a href=https://github.com/jaimegildesagredo/expects>expects</a>, <a href=https://github.com/gabrielfalcao/sure>sure</a>, etc. También puedes, lógicamente, no instalar ninguna librería adicional y usar los métodos <code>assert*</code> de <code>unittest.TestCase</code> o simplemente la instrucción <code>assert</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1>#test_foo.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>MagicMock</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>assertpy</span> <span class=kn>import</span> <span class=n>assert_that</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_foo</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>mock_foo</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>return_value</span><span class=o>=</span><span class=s2>&#34;Foo&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>assert_that</span><span class=p>(</span><span class=s2>&#34;Foo&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>is_equal_to</span><span class=p>(</span><span class=n>mock_foo</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=c1># assert &#34;Foo&#34; == mock_foo()</span>
</span></span></code></pre></div><p>La integración de <code>pytest</code> con <a href=https://code.visualstudio.com/>VSCode</a> y <a href=https://www.jetbrains.com/pycharm/>PyCharm</a> es perfecta y no tendrás que instalar ningún plugin adicional.</p><p><img src=images/VSCode.png alt></p><p><img src=images/PyCharm.png alt></p><p>Después de esta breve introducción, toca hablar de <em>mocking</em> y <em>patching</em>.</p><p>La primera pregunta que podría venirnos a la cabeza es <em>¿por qué tengo usar mocks?</em>. Tienes que <em>mockear</em> una dependencia de la <a href=http://xunitpatterns.com/SUT.html>unidad/SUT</a> que estás probando cuando quieres que se ejercite la unidad de forma aislada, cuando quieres controlar la ejecución del test con respuestas predefinidas que devuelvan lo que tú quieras, cuando te interesa preguntar cuál ha sido el uso que ha tenido la dependencia en el test (esto es si se ha llamado, con qué parámetros, etc.), cuando no quieras usar la implementación real porque tendría un alto coste o directamente es inviable (en términos de tiempo, requisitos de infraestructura, etc.), cuando aun no esté disponible la implementación real (dependes de un componente de terceros que está desarrollándose o estás haciendo TDD outside-in), etc.</p><blockquote><p>En líneas generales, quédate con que un mock es <em>&ldquo;un objeto simulado que imita el comportamiento de un objeto real de forma controlada&rdquo;</em>.</p></blockquote><p>Esta explicación da para <del>un post</del> <em>una serie de posts</em>, por lo que te recomiendo leer alguno de los siguientes enlaces donde se cuenta las diferencias que hay entre los distintos dobles de tests: <a href=https://martinfowler.com/bliki/TestDouble.html>TestDouble</a>, <a href=http://xunitpatterns.com/Test%20Double.html>Test Double</a>, <a href=https://martinfowler.com/articles/mocksArentStubs.html>Mocks Aren&rsquo;t Stubs</a>, <a href=https://www.carlosble.com/traducciones/mocksArentStubs.pdf>Mocks Aren&rsquo;t Stubs</a> (<em>traducción de Carlos Blé del artículo original de Martin Fowler</em>).</p><blockquote><p>En la práctica llamamos mock a cualquier doble de test porque se ha impuesto la palabra mock. Esto es porque muchos frameworks han sobreutilizado la palabra mock. Por ejemplo (y usando ejemplos principalmente de .NET), <a href=https://github.com/moq/moq>Moq</a>, <a href=https://hibernatingrhinos.com/oss/rhino-mocks>Rhino Mocks</a>, <a href=https://fakeiteasy.github.io/>FakeItEasy</a>, o incluso el propio <a href=https://docs.python.org/3/library/unittest.mock.html>unittest.mock</a> de Python. Todos ellos hablan de <em>mocking</em> sin más y, aunque es cierto que hay diferencias entre los distintos tipos de dobles de test, en mi opinión resulta más práctico hablar de mocks que estar discutiendo sobre si el reemplazo es un <em>dummy</em>, un <em>fake</em>, un <em>stub</em>, un <em>spy</em> o un <em>mock</em>. A este respecto me gusta mucho lo que dice <a href=https://nsubstitute.github.io/>NSubstitute</a> <em>&ldquo;Mock, stub, fake, spy, test double? Strict or loose? Nah, just substitute for the type you need!&rdquo;</em></p></blockquote><p>Habiendo explicado (muy por encima) el porqué necesitamos usar mocks y que distintos tipos hay, ¡usémoslos en Python!.</p><p>Lo primero que necesitamos es un SUT con algunas dependencias que queramos <em>mockear</em>. Usaremos el manido ejemplo de un servicio y un repositorio.</p><blockquote><p>Aunque se puede usar <code>Mock</code>, en Python se suele usar <a href=https://docs.python.org/3/library/unittest.mock.html#magic-mock>MagicMock</a> que no es más un Mock con algunos magic methods ya implementados.</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>abc</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Iterable</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pyodbc</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>assertpy</span> <span class=kn>import</span> <span class=n>assert_that</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>User</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>active</span><span class=p>:</span> <span class=nb>bool</span>
</span></span><span class=line><span class=cl>    <span class=n>email</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>UsersRepository</span><span class=p>(</span><span class=n>abc</span><span class=o>.</span><span class=n>ABC</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nd>@abc.abstractmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_all</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>active</span><span class=p>:</span> <span class=nb>bool</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Iterable</span><span class=p>[</span><span class=n>User</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DatabaseUsersRepository</span><span class=p>(</span><span class=n>UsersRepository</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>connstring</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_connstring</span> <span class=o>=</span> <span class=n>connstring</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_all</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>active</span><span class=p>:</span> <span class=nb>bool</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Iterable</span><span class=p>[</span><span class=n>User</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>connection</span> <span class=o>=</span> <span class=n>pyodbc</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_connstring</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span> <span class=o>=</span> <span class=n>connection</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>sql</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;SELECT Id, Name, Email FROM Users WHERE Active = </span><span class=si>{</span><span class=s1>&#39;1&#39;</span> <span class=k>if</span> <span class=n>active</span> <span class=k>else</span> <span class=s1>&#39;0&#39;</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>sql</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>row</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>users</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=n>row</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>users</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>User</span><span class=p>(</span><span class=n>row</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>row</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=kc>True</span><span class=p>,</span> <span class=n>row</span><span class=p>[</span><span class=mi>2</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>            <span class=n>row</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EmailSender</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>send</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sender</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>recipient</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>body</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># TODO Send email</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>UsersService</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>users_repository</span><span class=p>:</span> <span class=n>UsersRepository</span><span class=p>,</span> <span class=n>email_sender</span><span class=p>:</span> <span class=n>EmailSender</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_users_repository</span> <span class=o>=</span> <span class=n>users_repository</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_email_sender</span> <span class=o>=</span> <span class=n>email_sender</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>send_email_to_users_in_domain</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>recipient</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>domain_to_filter</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Iterable</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>sent_emails</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>user</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_users_repository</span><span class=o>.</span><span class=n>get_all</span><span class=p>(</span><span class=n>active</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>user</span><span class=o>.</span><span class=n>email</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=n>domain_to_filter</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_email_sender</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>user</span><span class=o>.</span><span class=n>email</span><span class=p>,</span> <span class=n>recipient</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;Hello </span><span class=si>{</span><span class=n>user</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2> in domain </span><span class=si>{</span><span class=n>domain_to_filter</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>sent_emails</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>user</span><span class=o>.</span><span class=n>email</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>sent_emails</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_send_email_to_users_in_domain</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>connstring</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;DRIVER=</span><span class=se>{{</span><span class=s2>ODBC Driver 17 for SQL Server</span><span class=se>}}</span><span class=s2>;SERVER=(local);DATABASE=mocking;UID=sa;PWD=P@ssw0rd;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>users_repository</span> <span class=o>=</span> <span class=n>DatabaseUsersRepository</span><span class=p>(</span><span class=n>connstring</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>email_sender</span> <span class=o>=</span> <span class=n>EmailSender</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>users_service</span> <span class=o>=</span> <span class=n>UsersService</span><span class=p>(</span><span class=n>users_repository</span><span class=p>,</span> <span class=n>email_sender</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>actual</span> <span class=o>=</span> <span class=n>users_service</span><span class=o>.</span><span class=n>send_email_to_users_in_domain</span><span class=p>(</span><span class=s2>&#34;no-reply@panicoenlaxbox.com&#34;</span><span class=p>,</span> <span class=s2>&#34;gmail.com&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>assert_that</span><span class=p>(</span><span class=n>actual</span><span class=p>)</span><span class=o>.</span><span class=n>is_equal_to</span><span class=p>([</span><span class=s2>&#34;panicoenlaxbox@gmail.com&#34;</span><span class=p>])</span>
</span></span></code></pre></div><p>En este ejemplo el SUT es el método <code>UsersService.send_email_to_users_in_domain</code>. Sin embargo, para poder ejecutar el test es necesario tener una BD con una tabla <code>Users</code>, donde además tiene que haber un sólo registro con un usuario activo y con el email <code>panicoenlaxbox@gmail.com</code>. Más adelante (cuando presumiblemente esté hecho el <code>#TODO</code> de <code>EmailSender.send</code>), tendríamos que configurar las credenciales para el envío de correo (y cruzar los dedos para que el servicio que estemos usando no esté caído o tenga algún tipo de <em>throttling</em>).</p><p>Es obvio que estamos frente a un test de integración de libro. Un test lento y que además parece nos demandará mucho esfuerzo de configuración previa. La idea original del test era probar <code>UsersService.send_email_to_users_in_domain</code>, no <code>UsersRepository</code> ni <code>EmailSender</code>.</p><blockquote><p>Si quisiésemos de verdad ejecutar el test y que fuera <a href=https://howtodoinjava.com/best-practices/first-principles-for-good-tests/>FIRST</a>, tendríamos que usar las <a href=https://docs.pytest.org/en/7.1.x/explanation/fixtures.html>fixtures</a> de <code>pytest</code> para hacer un setup/cleanup en condiciones (crear la BD, reiniciar el estado de la tabla <code>Users</code>, insertar datos semilla, etc.).</p></blockquote><p>¿Cómo lo hacemos entonces para testear sólo lo que queramos y que las dependencias de nuestro SUT no sean un problema? Ya lo sabes, <em>mockeando</em>.</p><p>Y es aquí donde te puedes encontrar (a grandes rasgos) dos distintos escenarios:</p><ul><li>Si tu código usa inyección de dependencias&mldr;, <em>!estás de enhorabuena!</em>. Tú código es testeable y por eso reemplazar las dependencias por un <em>mock</em> debería de ser <em>coser y cantar</em>.</li><li>Si tu código no usa inyección de dependencias&mldr; <em>!monkey patching al rescate!</em>.<ul><li>En Python está muy arraigada esta práctica, pero en otros lenguajes no está tan bien resuelta (por ejemplo en .NET y, aunque hay librerías como <a href=https://github.com/pardeike/Harmony>Harmony</a> o <a href=https://github.com/tonerdo/pose>pose</a>, si puedes evitarlas&mldr; mejor).</li></ul></li></ul><p>Veamos en código las diferencias entre hacer <em>mocking</em> y <em>patching</em>.</p><p>Primero hagamos que nuestro test sea unitario de verdad usando <em>mocking</em>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_send_email_to_users_in_domain</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>mock_users_repository</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>()</span>  <span class=c1># stub</span>
</span></span><span class=line><span class=cl>    <span class=n>mock_users_repository</span><span class=o>.</span><span class=n>get_all</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=p>[</span><span class=n>User</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;Sergio&#34;</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=s2>&#34;panicoenlaxbox@gmail.com&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=n>mock_email_sender</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>()</span>  <span class=c1># dummy</span>
</span></span><span class=line><span class=cl>    <span class=n>users_service</span> <span class=o>=</span> <span class=n>UsersService</span><span class=p>(</span><span class=n>mock_users_repository</span><span class=p>,</span> <span class=n>mock_email_sender</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>actual</span> <span class=o>=</span> <span class=n>users_service</span><span class=o>.</span><span class=n>send_email_to_users_in_domain</span><span class=p>(</span><span class=s2>&#34;no-reply@panicoenlaxbox.com&#34;</span><span class=p>,</span> <span class=s2>&#34;gmail.com&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>assert_that</span><span class=p>(</span><span class=n>actual</span><span class=p>)</span><span class=o>.</span><span class=n>is_equal_to</span><span class=p>([</span><span class=s2>&#34;panicoenlaxbox@gmail.com&#34;</span><span class=p>])</span>
</span></span></code></pre></div><p><em>easy-peasy!</em> Puesto que <code>UsersService</code> recibía por constructor las dependencias, reemplazarlas ha sido muy fácil.</p><p>Hagamos a continuación un <del>pequeño</del> cambio en el código de producción. Básicamente, prescindir de la D de SOLID.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>UsersService</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>connstring</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;DRIVER=</span><span class=se>{{</span><span class=s2>ODBC Driver 17 for SQL Server</span><span class=se>}}</span><span class=s2>;SERVER=(local);DATABASE=mocking;UID=sa;PWD=P@ssw0rd;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_users_repository</span> <span class=o>=</span> <span class=n>DatabaseUsersRepository</span><span class=p>(</span><span class=n>connstring</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_email_sender</span> <span class=o>=</span> <span class=n>EmailSender</span><span class=p>()</span>
</span></span></code></pre></div><p>Ahora nuestro código ya no es tan testeable. Las dependencias son implícitas y no hay forma sencilla de cambiar el comportamiento de <code>UsersService</code>. Recuerda, <a href=https://ardalis.com/new-is-glue/>new is glue</a>.</p><p>Hacer pasar el test es sencillo (siempre y cuando tengas una BD lista y con el estado adecuado)&mldr; pero ahora estamos peor que antes, el código de producción es una caja negra y no parece ofrecer ningún punto de extensión.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_send_email_to_users_in_domain</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>users_service</span> <span class=o>=</span> <span class=n>UsersService</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>actual</span> <span class=o>=</span> <span class=n>users_service</span><span class=o>.</span><span class=n>send_email_to_users_in_domain</span><span class=p>(</span><span class=s2>&#34;no-reply@panicoenlaxbox.com&#34;</span><span class=p>,</span> <span class=s2>&#34;gmail.com&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>assert_that</span><span class=p>(</span><span class=n>actual</span><span class=p>)</span><span class=o>.</span><span class=n>is_equal_to</span><span class=p>([</span><span class=s2>&#34;panicoenlaxbox@gmail.com&#34;</span><span class=p>])</span>
</span></span></code></pre></div><p>Para resolver esta <em>incómoda situación</em>, es donde el <em>patching</em> aparece en escena. La idea es reescribir nuestro código en tiempo de ejecución.</p><p>Veamos primero con un ejemplo sencillo (y que no usa la <em>stdlib</em>) que es exactamente el <em>patching</em>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>old_open</span> <span class=o>=</span> <span class=nb>open</span>  <span class=c1># save original reference</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>custom_open</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=n>mode</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;You are opening </span><span class=si>{</span><span class=n>path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>  <span class=c1># this is our extra code</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>old_open</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=n>mode</span><span class=p>)</span>  <span class=c1># call to the original implementation</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>open</span> <span class=o>=</span> <span class=n>custom_open</span>  <span class=c1># Monkey patching</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;C:</span><span class=se>\\</span><span class=s2>Temp</span><span class=se>\\</span><span class=s2>foo.txt&#34;</span><span class=p>,</span> <span class=s2>&#34;wt&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s2>&#34;foo&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>open</span> <span class=o>=</span> <span class=n>old_open</span>  <span class=c1># restore original reference, unpatch</span>
</span></span></code></pre></div><p>Ahora usemos ya sí <code>unittest.mock</code> para hacer <em>patching</em> y que nuestro test sea equivalente al test que usaba código de producción que sí era testeable (y era mejor, obvio).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_send_email_to_users_in_domain</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>patch</span><span class=p>(</span><span class=s2>&#34;tests.test_foo.DatabaseUsersRepository&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>mock_database_users_repository</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>mock_database_users_repository</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>get_all</span><span class=o>=</span><span class=n>MagicMock</span><span class=p>(</span><span class=n>return_value</span><span class=o>=</span><span class=p>[</span><span class=n>User</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;Sergio&#34;</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=s2>&#34;panicoenlaxbox@gmail.com&#34;</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>patch</span><span class=p>(</span><span class=s2>&#34;tests.test_foo.EmailSender&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># In UsersService.__init__, self._email_sender = EmailSender() will create a mock object</span>
</span></span><span class=line><span class=cl>            <span class=n>users_service</span> <span class=o>=</span> <span class=n>UsersService</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>actual</span> <span class=o>=</span> <span class=n>users_service</span><span class=o>.</span><span class=n>send_email_to_users_in_domain</span><span class=p>(</span><span class=s2>&#34;no-reply@panicoenlaxbox.com&#34;</span><span class=p>,</span> <span class=s2>&#34;gmail.com&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>assert_that</span><span class=p>(</span><span class=n>actual</span><span class=p>)</span><span class=o>.</span><span class=n>is_equal_to</span><span class=p>([</span><span class=s2>&#34;panicoenlaxbox@gmail.com&#34;</span><span class=p>])</span>
</span></span></code></pre></div><blockquote><p>Es importante no confundir <a href=https://docs.python.org/3/library/unittest.mock.html#patch>patch</a> del módulo <code>unittest.mock</code> con el fixture <a href=https://docs.pytest.org/en/latest/how-to/monkeypatch.html>monkeypatch</a> de pytest. Además, <code>patch</code> puede ser usado como context manager pero también como decorador.</p></blockquote><p>Como decorador, sería así:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@patch</span><span class=p>(</span><span class=s2>&#34;tests.test_foo.EmailSender&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nd>@patch</span><span class=p>(</span><span class=s2>&#34;tests.test_foo.DatabaseUsersRepository&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_send_email_to_users_in_domain</span><span class=p>(</span><span class=n>mock_database_users_repository</span><span class=p>,</span> <span class=n>mock_email_sender</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>mock_database_users_repository</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>get_all</span><span class=o>=</span><span class=n>MagicMock</span><span class=p>(</span><span class=n>return_value</span><span class=o>=</span><span class=p>[</span><span class=n>User</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;Sergio&#34;</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=s2>&#34;panicoenlaxbox@gmail.com&#34;</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>users_service</span> <span class=o>=</span> <span class=n>UsersService</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>actual</span> <span class=o>=</span> <span class=n>users_service</span><span class=o>.</span><span class=n>send_email_to_users_in_domain</span><span class=p>(</span><span class=s2>&#34;no-reply@panicoenlaxbox.com&#34;</span><span class=p>,</span> <span class=s2>&#34;gmail.com&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>assert_that</span><span class=p>(</span><span class=n>actual</span><span class=p>)</span><span class=o>.</span><span class=n>is_equal_to</span><span class=p>([</span><span class=s2>&#34;panicoenlaxbox@gmail.com&#34;</span><span class=p>])</span>
</span></span></code></pre></div><p>Como puedes ver, hemos <em>hackeado</em> nuestro código (no se me ocurre mejor verbo para ilustrar lo sucedido). Dentro del bloque <code>with</code>, el código del módulo <code>tests.test_foo</code> que use <code>DatabaseUsersRepository</code> usará nuestro mock (porque hacer <em>patch</em> te devuelve un <em>mock</em>) en vez de la implementación real. ¡Salvados por la campana!</p><p><img src=images/patch.png alt></p><p>El lado oscuro del <em>patching</em> es que debes tener muy claro <em>&ldquo;que estás parcheando&rdquo;</em>. La regla de oro es que debes hacer patch <em>&ldquo;donde se esté usando lo que quieres parchear, no donde esté implementado&rdquo;</em>, puedes ampliar info <a href=https://docs.python.org/3/library/unittest.mock.html#where-to-patch>aquí</a> <em>&ldquo;The basic principle is that you patch where an object is looked up, which is not necessarily the same place as where it is defined&rdquo;</em>. Es decir, en nuestro caso sólo tenemos un módulo <code>test_foo.py</code> y allí tenemos tanto el código de producción como el código de test. Por eso el patch es sobre <code>tests.test_foo.DatabaseUsersRepository</code> y todo funciona. Si movemos el código de producción a la raíz del proyecto, ahora el <em>patch</em> dependerá de cómo importemos el módulo <code>users_service.py</code> en el módulo <code>test_foo.py</code>, que es donde se está usando.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>MagicMock</span><span class=p>,</span> <span class=n>patch</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>assertpy</span> <span class=kn>import</span> <span class=n>assert_that</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>user</span> <span class=kn>import</span> <span class=n>User</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>users_service</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_send_email_to_users_in_domain</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>patch</span><span class=p>(</span><span class=s2>&#34;tests.test_foo.users_service.DatabaseUsersRepository&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>mock_database_users_repository</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>mock_database_users_repository</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>get_all</span><span class=o>=</span><span class=n>MagicMock</span><span class=p>(</span><span class=n>return_value</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>User</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;Sergio&#34;</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=s2>&#34;panicoenlaxbox@gmail.com&#34;</span><span class=p>)]))</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>patch</span><span class=p>(</span><span class=s2>&#34;tests.test_foo.users_service.EmailSender&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>users_service_</span> <span class=o>=</span> <span class=n>users_service</span><span class=o>.</span><span class=n>UsersService</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>actual</span> <span class=o>=</span> <span class=n>users_service_</span><span class=o>.</span><span class=n>send_email_to_users_in_domain</span><span class=p>(</span><span class=s2>&#34;no-reply@panicoenlaxbox.com&#34;</span><span class=p>,</span> <span class=s2>&#34;gmail.com&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>assert_that</span><span class=p>(</span><span class=n>actual</span><span class=p>)</span><span class=o>.</span><span class=n>is_equal_to</span><span class=p>([</span><span class=s2>&#34;panicoenlaxbox@gmail.com&#34;</span><span class=p>])</span>
</span></span></code></pre></div><p>Fíjate que después de mover todo el código de producción a la raíz del proyecto, hemos tenido que cambiar la forma de importar <code>users_service</code> y también la ruta de lo que queremos <em>patchear</em>, de <code>tests.test_foo.DatabaseUsersRepository</code> a <code>tests.test_foo.users_service.DatabaseUsersRepository</code>. Y si se usara <code>DatabaseUsersRepository</code> en algún otro sitio que no fuera <code>UsersService</code> tendríamos un problema porque eso no estaría parcheado y usaría la implementación original.</p><p>Otro problema es el tiempo de aplicación del parche. Cuando hagas un <em>patch</em> también tienes que tener muy claro cuando se hará el <em>unpatch</em>, porque si no tus tests van a depender entre ellos y eso es un problema.</p><blockquote><p>Que puedas hacer algo no significa que debas. Salvo raras excepciones (y es mi opinión), si haces mucho <em>patching</em> es probable que tu diseño no sea el mejor (esto es una forma suave de decir que tu código es&mldr; bueno, <em>no testeable</em> es suficiente para que pienses que no está bien).</p></blockquote><p>Algunos casos donde creo el patching puede ser un salvavidas es cuando uses librerías que son un <em>must-know</em>, como por ejemplo:</p><ul><li><a href=https://github.com/getsentry/responses>responses</a>, patching automático para <a href=https://requests.readthedocs.io/en/latest/>requests</a>, lo mismo te ahorras (si quieres) una abstracción sobre <em>requests</em>.</li><li><a href=https://github.com/spulec/freezegun>FreezeGun</a> porque me da mucha pereza hacer una <a href=https://stackoverflow.com/questions/2425721/unit-testing-datetime-now>abstracción sobre datetime</a>.</li><li><a href=https://github.com/jmcgeheeiv/pyfakefs/>pyfakefs</a> para trabajar sobre un sistema de ficheros virtual.</li></ul><p>Con independencia de si usas <em>patching</em> o <em>mocking</em>, algo a tener muy en cuenta es la especificación del mock. En todos nuestros ejemplos (ya sea creando a mano el <em>mock</em> o usando <code>patch</code>), nuestro <em>mock</em> responde a cualquier llamada&mldr; es un <em>traga-bolas</em>. Lógicamente eso no está bien porque, fácilmente podría pasar que tuviéramos un test en verde con código de producción que no es correcto, así que la sorpresa vendría después con alevosía y nocturnidad (cuando ya esté publicado el código en producción).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># test code</span>
</span></span><span class=line><span class=cl><span class=n>mock_users_repository</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>mock_users_repository</span><span class=o>.</span><span class=n>get_all</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=p>[</span><span class=n>User</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;Sergio&#34;</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=s2>&#34;panicoenlaxbox@gmail.com&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># production code</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>user</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_users_repository</span><span class=o>.</span><span class=n>get_all</span><span class=p>(</span><span class=n>active</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>a_non_existing_parameter</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
</span></span></code></pre></div><p>En este ejemplo, el código de producción llama al método <code>self._users_repository.get_all</code> con el parámetro extra <code>a_non_existing_parameter</code>. El test pasa porque el mock no tiene problema con ello, pero el código de producción fallaría con <code>TypeError: DatabaseUsersRepository.get_all() got an unexpected keyword argument 'a_non_existing_parameter'</code>.</p><blockquote><p>Cierto es que si usas <a href=https://mypy-lang.org/>mypy</a>&mldr; porque lo usas ¿verdad? te cantaría el error del código de producción, pero&mldr;</p></blockquote><p>La conclusión es que <code>mock = MagicMock()</code> no basta y tenemos que ser un poco más concretos a la hora de declarar nuestros <em>mocks</em>.</p><p>Trabajaremos sobre este ejemplo para ir refinándolo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>MagicMock</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Dog</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>color</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>color</span> <span class=o>=</span> <span class=n>color</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>bark</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;A </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>color</span><span class=si>}</span><span class=s2> dog is barking&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>bark</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>bark</span><span class=p>(</span><span class=s2>&#34;slow&#34;</span><span class=p>)</span>  <span class=c1># bark does not receive a str argument, but it works</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>meow</span><span class=p>()</span>  <span class=c1># meow works, but it does not exist in Dog class, it shouldn&#39;t work</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>tweet</span> <span class=o>=</span> <span class=k>lambda</span><span class=p>:</span> <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;A dog is tweeting&#34;</span><span class=p>)</span>  <span class=c1># We can add new methods to our mock, do we want this?</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>tweet</span><span class=p>()</span>
</span></span></code></pre></div><p>En una primera aproximación podríamos usar <code>spec</code>, <code>spec_set</code> y <code>seal</code>.</p><p>Con <a href=https://docs.python.org/3/library/unittest.mock.html#the-mock-class>spec</a> podemos pasarle una lista de strings, una clase o un objeto. Si es clase u objeto se llamará a <code>dir</code> sobre el mismo. En cualquier caso, lo que estamos haciendo es crear una especificación en el <em>mock</em>, por lo que si llamamos a un método que no existe, el <em>mock</em> fallará con <code>AttributeError</code>. Como contrapartida, <code>spec</code> no valida parámetros y podemos seguir añadiendo métodos al <em>mock</em>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nb>print</span><span class=p>([</span><span class=n>attr</span> <span class=k>for</span> <span class=n>attr</span> <span class=ow>in</span> <span class=nb>dir</span><span class=p>(</span><span class=n>Dog</span><span class=p>)</span> <span class=k>if</span> <span class=ow>not</span> <span class=n>attr</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;__&#34;</span><span class=p>)])</span>  <span class=c1># [&#39;bark&#39;]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>my_dog</span> <span class=o>=</span> <span class=n>Dog</span><span class=p>(</span><span class=s2>&#34;brown&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>([</span><span class=n>attr</span> <span class=k>for</span> <span class=n>attr</span> <span class=ow>in</span> <span class=nb>dir</span><span class=p>(</span><span class=n>my_dog</span><span class=p>)</span> <span class=k>if</span> <span class=ow>not</span> <span class=n>attr</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;__&#34;</span><span class=p>)])</span>  <span class=c1># [&#39;bark&#39;, &#39;color&#39;]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>spec</span><span class=o>=</span><span class=n>Dog</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>mock_dog</span><span class=p>,</span> <span class=n>Dog</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>bark</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># print(mock_dog.color)  # Only if we used my_dog as spec</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>bark</span><span class=p>(</span><span class=s2>&#34;slow&#34;</span><span class=p>)</span>  <span class=c1># 😒, bark with parameter continues working</span>
</span></span><span class=line><span class=cl><span class=c1># mock_dog.meow() # AttributeError: Mock object has no attribute &#39;meow&#39;</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>tweet</span> <span class=o>=</span> <span class=k>lambda</span><span class=p>:</span> <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;A dog is tweeting&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>tweet</span><span class=p>()</span>
</span></span></code></pre></div><p>La variante con una lista de strings como <code>spec</code> también es válida:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>mock_dog</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>spec</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;bark&#34;</span><span class=p>,</span> <span class=s2>&#34;color&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>mock_dog</span><span class=p>,</span> <span class=n>Dog</span><span class=p>)</span>  <span class=c1># Now, mock_dog is not a Dog instance</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>bark</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>mock_dog</span><span class=o>.</span><span class=n>color</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>bark</span><span class=p>(</span><span class=s2>&#34;slow&#34;</span><span class=p>)</span>  <span class=c1># 😒, bark with parameter continues working</span>
</span></span><span class=line><span class=cl><span class=c1># mock_dog.meow() # AttributeError: Mock object has no attribute &#39;meow&#39;</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>tweet</span> <span class=o>=</span> <span class=k>lambda</span><span class=p>:</span> <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;A dog is tweeting&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>tweet</span><span class=p>()</span>
</span></span></code></pre></div><p>Con <code>spec_set</code> (una variante de <code>spec</code>) subimos un poco el nivel y ahora no podremos agregar métodos al <em>mock</em>, porque digo yo&mldr; no queremos inventarnos métodos ¿no?.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>mock_dog</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>spec_set</span><span class=o>=</span><span class=n>Dog</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>bark</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>bark</span><span class=p>(</span><span class=s2>&#34;slow&#34;</span><span class=p>)</span>  <span class=c1># 😒, bark with parameter continues working</span>
</span></span><span class=line><span class=cl><span class=c1># mock_dog.meow() # AttributeError: Mock object has no attribute &#39;meow&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># mock_dog.tweet = lambda: print(f&#34;A dog is tweeting&#34;)  # AttributeError: Mock object has no attribute &#39;tweet&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># mock_dog.tweet()</span>
</span></span></code></pre></div><p>Con <a href=https://docs.python.org/3/library/unittest.mock.html#sealing-mocks>seal</a>, nos ponemos un poco más <em>hardcore</em> y sólo podremos llamar a métodos que hayan sido configurados previamente. Además también resolvemos que los parámetros suministrados no coincidan con la firma real del método.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>mock_dog</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>spec_set</span><span class=o>=</span><span class=n>Dog</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>seal</span><span class=p>(</span><span class=n>mock_dog</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>bark</span><span class=p>()</span>  <span class=c1># AttributeError: mock.bark</span>
</span></span></code></pre></div><p>Toca configuarar el <em>mock</em> toca previamente:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>mock_dog</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>spec_set</span><span class=o>=</span><span class=n>Dog</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>bark</span><span class=o>.</span><span class=n>side_effect</span> <span class=o>=</span> <span class=k>lambda</span><span class=p>:</span> <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Barking from a mock&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>seal</span><span class=p>(</span><span class=n>mock_dog</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>bark</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># mock_dog.bark(&#34;slow&#34;)  # TypeError: &lt;lambda&gt;() takes 0 positional arguments but 1 was given</span>
</span></span></code></pre></div><p>El constructor de <code>MagicMock</code> recibe como último parámetro <code>**kwargs</code> lo que permite crearlo y configurarlo en un sólo paso:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>mock_dog</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>spec_set</span><span class=o>=</span><span class=n>Dog</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>bark</span><span class=o>.</span><span class=n>side_effect</span> <span class=o>=</span> <span class=k>lambda</span><span class=p>:</span> <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Barking from a mock&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># a short version of the above</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog2</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>spec_set</span><span class=o>=</span><span class=n>Dog</span><span class=p>,</span> <span class=o>**</span><span class=p>{</span><span class=s2>&#34;bark.side_effect&#34;</span><span class=p>:</span> <span class=k>lambda</span><span class=p>:</span> <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Barking from a mock&#34;</span><span class=p>)})</span>
</span></span></code></pre></div><p>En este punto, mi recomendación es usar <code>spec_set</code> y <code>seal</code>. Ahora sí, tenemos un <em>Mock</em> confiable y que sustituye a la dependencia real con garantías.</p><p>Algo que seguro te dará guerra (y que hemos estando obviando hasta ahora) son las propiedades de instancia creadas en el <del>constructor</del> inicializador.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>MagicMock</span><span class=p>,</span> <span class=n>seal</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Dog</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>color</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>color</span> <span class=o>=</span> <span class=n>color</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>bark</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;A </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>color</span><span class=si>}</span><span class=s2> dog is barking&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>spec_set</span><span class=o>=</span><span class=n>Dog</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>seal</span><span class=p>(</span><span class=n>mock_dog</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>mock_dog</span><span class=o>.</span><span class=n>color</span><span class=p>)</span>  <span class=c1># AttributeError: Mock object has no attribute &#39;color&#39;</span>
</span></span></code></pre></div><p>Esto sucede porque <code>MagicMock</code> no ejecuta el código de <code>__init__</code>, luego no sabe que existe la propiedad <code>color</code>.</p><p>Houston, tenemos un problema ¿Qué podemos hacer?</p><ul><li>Añadir estas propiedades a mano en el <em>mock</em>&mldr; pero entonces no podríamos usar <code>spec_set</code>.</li><li><del>Pasar las variables de instancia a variables de clase&mldr;</del>&mldr; no es una solución, es otro diseño, otra aplicación.</li><li>Crear el mock a partir de una instancia de objeto o de una lista de strings (no de una clase).</li><li>Pasar los atributos de instancia a <code>@property</code> y usar <code>PropertyMock</code> en la configuración del <em>mock</em>.</li></ul><p>Si usamos una lista de strings el problema es que estamos <em>hardcodeando</em> strings y eso puede llevarnos a errores, pero bueno&mldr;</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>mock_dog</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>spec_set</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;bark&#39;</span><span class=p>,</span> <span class=s1>&#39;color&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>bark</span><span class=o>.</span><span class=n>side_effect</span> <span class=o>=</span> <span class=k>lambda</span><span class=p>:</span> <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;A </span><span class=si>{</span><span class=n>mock_dog</span><span class=o>.</span><span class=n>color</span><span class=si>}</span><span class=s2> dog is barking&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>color</span> <span class=o>=</span> <span class=s2>&#34;brown&#34;</span>
</span></span><span class=line><span class=cl><span class=n>seal</span><span class=p>(</span><span class=n>mock_dog</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>bark</span><span class=p>()</span>  <span class=c1># A brown dog is barking</span>
</span></span></code></pre></div><p>Además no funcionará <code>isintance</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>mock_dog</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>spec_set</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;bark&#39;</span><span class=p>,</span> <span class=s1>&#39;color&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>seal</span><span class=p>(</span><span class=n>mock_dog</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>mock_dog</span><span class=p>,</span> <span class=n>Dog</span><span class=p>)</span>
</span></span></code></pre></div><p>Aunque podemos solucionarlo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>mock_dog</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>spec_set</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;bark&#39;</span><span class=p>,</span> <span class=s1>&#39;color&#39;</span><span class=p>,</span> <span class=s1>&#39;__class__&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=vm>__class__</span> <span class=o>=</span> <span class=n>Dog</span>
</span></span><span class=line><span class=cl><span class=n>seal</span><span class=p>(</span><span class=n>mock_dog</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>mock_dog</span><span class=p>,</span> <span class=n>Dog</span><span class=p>)</span>
</span></span></code></pre></div><p>Si pasamos las propiedades de instancia a <code>@property</code> (que también te digo no apetece hacer esto porque nos obligue a ello el <em>Mock</em>, sino hacerlo porque realmente lo querías acorde a tu diseño&mldr;):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>MagicMock</span><span class=p>,</span> <span class=n>seal</span><span class=p>,</span> <span class=n>PropertyMock</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>MagicMock</span><span class=p>,</span> <span class=n>PropertyMock</span><span class=p>,</span> <span class=n>seal</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Dog</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>color</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>color</span> <span class=o>=</span> <span class=n>color</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>bark</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;A </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>color</span><span class=si>}</span><span class=s2> dog is barking&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@property</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>color</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_color</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@color.setter</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>color</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_color</span> <span class=o>=</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>spec_set</span><span class=o>=</span><span class=n>Dog</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># https://docs.python.org/3/library/unittest.mock.html#unittest.mock.PropertyMock</span>
</span></span><span class=line><span class=cl><span class=nb>type</span><span class=p>(</span><span class=n>mock_dog</span><span class=p>)</span><span class=o>.</span><span class=n>color</span> <span class=o>=</span> <span class=n>PropertyMock</span><span class=p>(</span><span class=n>return_value</span><span class=o>=</span><span class=s2>&#34;brown&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>seal</span><span class=p>(</span><span class=n>mock_dog</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>color</span> <span class=o>=</span> <span class=s2>&#34;white&#34;</span>  <span class=c1># Let&#39;s image that this code is production code...</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>mock_dog</span><span class=o>.</span><span class=n>color</span><span class=p>)</span>  <span class=c1># because PropertyMock was configured to return &#34;black&#34;, it will return &#34;black&#34; instead of &#34;white&#34;</span>
</span></span></code></pre></div><p>En este último ejemplo también hemos visto la diferencia entre usar <code>mock_dog.color="brown"</code> o <code>type(mock_dog).color = PropertyMock(return_value="brown")</code> cuando estamos configurando el <em>Mock</em>.</p><p>En cualquier caso, hay que reconocer que se está complicando crear el <em>mock</em> definitivo.</p><p>Como alternativa al constructor de <code>MagicMock</code> podemos usar <a href=https://docs.python.org/3/library/unittest.mock.html#auto-speccing>autospeccing</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>PropertyMock</span><span class=p>,</span> <span class=n>create_autospec</span><span class=p>,</span> <span class=n>seal</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Dog</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>color</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>color</span> <span class=o>=</span> <span class=n>color</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>bark</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;A </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>color</span><span class=si>}</span><span class=s2> dog is barking&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@property</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>color</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_color</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@color.setter</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>color</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_color</span> <span class=o>=</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span> <span class=o>=</span> <span class=n>create_autospec</span><span class=p>(</span><span class=n>spec</span><span class=o>=</span><span class=n>Dog</span><span class=p>,</span> <span class=n>spec_set</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>bark</span><span class=o>.</span><span class=n>side_effect</span> <span class=o>=</span> <span class=k>lambda</span><span class=p>:</span> <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;A </span><span class=si>{</span><span class=n>mock_dog</span><span class=o>.</span><span class=n>color</span><span class=si>}</span><span class=s2> dog is barking&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>type</span><span class=p>(</span><span class=n>mock_dog</span><span class=p>)</span><span class=o>.</span><span class=n>color</span> <span class=o>=</span> <span class=n>PropertyMock</span><span class=p>(</span><span class=n>return_value</span><span class=o>=</span><span class=s2>&#34;brown&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>seal</span><span class=p>(</span><span class=n>mock_dog</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>bark</span><span class=p>()</span>  <span class=c1># A brown dog is barking</span>
</span></span></code></pre></div><p>Finalmente, si no tienes que lidiar con propiedades (o ya tienes <code>@property</code>) te recomendaria <code>create_autospec</code> y <code>seal</code>. En caso contrario, lo más sensato parece usar <code>spect_set</code> con una lista de strings y <code>seal</code>. <em>No parece haber solución perfecta (o yo no la he encontrado&mldr; que será más probable).</em></p><blockquote><p>Por más digno que me ponga en este post, tengo que reconocer que muchas veces me seduce la simpleza de <code>mock = MagicMock()</code> y termino relajando la especificación del <em>mock</em> en aras de simplificar el <em>setup</em> del test. Ahora bien, estoy añadiendo un punto de fallo a mis tests y comprando deliberadamente un riesgo.</p></blockquote><p>Por ejemplo, que fácil es hacer lo siguiente:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>mock_foo</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>mock_foo</span><span class=o>.</span><span class=n>bar</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>mock_foo</span><span class=o>.</span><span class=n>bar</span><span class=o>.</span><span class=n>baz</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>mock_foo</span><span class=o>.</span><span class=n>bar</span><span class=o>.</span><span class=n>baz</span><span class=o>.</span><span class=n>qux</span> <span class=o>=</span> <span class=s2>&#34;quux&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>mock_foo</span><span class=o>.</span><span class=n>bar</span><span class=o>.</span><span class=n>baz</span><span class=o>.</span><span class=n>qux</span><span class=p>)</span>  <span class=c1># &#34;quux&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Equivalent to the above, more compact</span>
</span></span><span class=line><span class=cl><span class=n>mock_foo2</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=o>**</span><span class=p>{</span><span class=s2>&#34;bar.baz.qux&#34;</span><span class=p>:</span> <span class=s2>&#34;quux&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>mock_foo2</span><span class=o>.</span><span class=n>bar</span><span class=o>.</span><span class=n>baz</span><span class=o>.</span><span class=n>qux</span><span class=p>)</span>  <span class=c1># &#34;quux&#34;</span>
</span></span></code></pre></div><p>Por último, y aunque es un caso más excepcional, puede ser que ya tengas un objeto y quieras <em>mockear</em> sólo parte de su interfaz y para el resto llamar a la implementación real. Puedes hacerlo con el parámetro <code>wraps</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>MagicMock</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Dog</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>color</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>color</span> <span class=o>=</span> <span class=n>color</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>bark</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;A </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>color</span><span class=si>}</span><span class=s2> dog is barking&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>walk</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;A </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>color</span><span class=si>}</span><span class=s2> dog is walking&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dog</span> <span class=o>=</span> <span class=n>Dog</span><span class=p>(</span><span class=s2>&#34;brown&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>wraps</span><span class=o>=</span><span class=n>dog</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>bark</span><span class=p>()</span>  <span class=c1># It will call the original method</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>walk</span><span class=o>.</span><span class=n>side_effect</span> <span class=o>=</span> <span class=k>lambda</span><span class=p>:</span> <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;I don&#39;t want to walk&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>walk</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># We spy on the dog instance</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>bark</span><span class=o>.</span><span class=n>assert_called_once</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>mock_dog</span><span class=o>.</span><span class=n>walk</span><span class=o>.</span><span class=n>assert_called_once</span><span class=p>()</span>
</span></span></code></pre></div><p>¡Un saludo!</p><div class=blog-tags><a href=https://panicoenlaxbox.com/tags/python/>python</a>&nbsp;</div><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2fpanicoenlaxbox.com%2fpost%2fmocking-vs-patching-python%2f&amp;text=Mocking%20vs%20patching%20en%20Python&amp;via=panicoenlaxbox" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fpanicoenlaxbox.com%2fpost%2fmocking-vs-patching-python%2f&amp;title=Mocking%20vs%20patching%20en%20Python" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li></ul></div></div></section><h4 class=see-also>Ver también</h4><ul><li><a href=/post/medir-lineas-de-codigo/>Medir líneas de código, clases y funciones en Python</a></li><li><a href=/post/poetry-add-editable/>Añadir dependencia editable con Poetry</a></li><li><a href=/post/upgrade-poetry-virtual-environment-python-version/>Actualizar versión de Python de un entorno virtual de Poetry</a></li><li><a href=/post/setup-m%C3%ADnimo-python/>Setup mínimo en python</a></li><li><a href=/post/alternativas-a-class-en-python/>Alternativas a class en Python</a></li></ul></article><ul class="pager blog-pager"><li class=previous><a href=https://panicoenlaxbox.com/post/configuration-and-secrets-in-asp-net-core/ data-toggle=tooltip data-placement=top title="Configuración y secretos en ASP.NET Core con Azure Key Vault y Azure App Configuration">&larr; Artículo anterior</a></li><li class=next><a href=https://panicoenlaxbox.com/post/alternativas-a-class-en-python/ data-toggle=tooltip data-placement=top title="Alternativas a class en Python">Artículo siguiente &rarr;</a></li></ul><div class=disqus-comments><button id=show-comments class="btn btn-default" type=button>Mostrar <span class=disqus-comment-count data-disqus-url=https://panicoenlaxbox.com/post/mocking-vs-patching-python>comentarios</span></button><div id=disqus_thread></div><script type=text/javascript>var disqus_config=function(){this.page.url="https://panicoenlaxbox.com/post/mocking-vs-patching-python"}</script></div></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=mailto:panicoenlaxbox@gmail.com title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/panicoenlaxbox title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/panicoenlaxbox title=Twitter><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://linkedin.com/in/sergio-le%c3%b3n-gonz%c3%a1lez-49412642 title=LinkedIn><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a href title=RSS><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted">Sergio León
&nbsp;&bull;&nbsp;&copy;
2023
&nbsp;&bull;&nbsp;
<a href=https://panicoenlaxbox.com>Programación desordenada</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.121.2</a> alimentada &nbsp;&bull;&nbsp; Tema <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adaptado de <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script><script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=https://panicoenlaxbox.com/js/main.js></script><script src=https://panicoenlaxbox.com/js/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>$(document).ready(function(){$("pre.chroma").css("padding","0")})</script><script>renderMathInElement(document.body)</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://panicoenlaxbox.com/js/load-photoswipe.js></script><script type=text/javascript>$(function(){$("#show-comments").on("click",function(){var e="panicoenlaxbox-github-io";(function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="//"+e+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(t)})(),$(this).hide()})})</script><script id=dsq-count-scr src=//panicoenlaxbox-github-io.disqus.com/count.js async></script></body></html>